# Собираем кластер elasticsearch

1. Заходим в директорию ```cd 01_prototype_by_docker_compose/02_elasticsearch_cluster```
2. Делаем ```docker-compose up```
3. Ждем примерно 1-2 минуты открываем в браузере <http://localhost:9200/_cat/nodes?v> или делаем в консоли ```curl http://localhost:9200/_cat/nodes?v```
    Результат должен быть таким:
    ```
    $ curl http://localhost:9200/_cat/nodes?v
    ip         heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
    172.22.0.4           16          97  35    2.23    1.76     1.55 mdi       -      es_3
    172.22.0.2           15          97  35    2.23    1.76     1.55 mdi       -      es_2
    172.22.0.3           17          97  35    2.23    1.76     1.55 mdi       *      es_1
    ```

    Такой ответ означает что наш кластер elasticsearch запустился успешно и готов принимать запросы. 
    Ответ читается как: в кластере три ноды, es_1 является мастером, в колонке ```node.role``` видим три буквы ```mdi```, читается как:
    * ```m``` - нода может быть мастером
    * ```d``` - нода может хранить данные 
    * ```i``` - нода может обрабатывать данные перед индексацией 

## Изменения в docker-compose.yaml
1. Были добавлены еще две ноды ```elastic_2``` и ```elastic_3```
2. ```node.name=...``` - имя каждой отдельной ноды, должно быть уникальным для каждой ноды в рамках кластера. У нас три ноды ```es_1```, ```es_2``` и ```es_3```
3. ```discovery.type=single-node``` - убрали параметр чтобы ноды могли собраться в кластер
4. ```discovery.seed_hosts=elastic_1:9300,elastic_2:9300,elastic_2:9300``` - список всех хостов нод в нашем кластере, обратите внимание что порт нужно указывать именно ```9300``` это служебный порт для общения нод в кластере. 
elastic_1 и elastic_2 - это хосты доступные внутри контейнеров, особенность работы docker-compose
5. ```cluster.initial_master_nodes=es_1``` - имя мастер ноды (значение ```node.name```) которая будет в ручную выбрана при старте кластера, информация из этой ноды используется только один раз при запуске кластера, когда нет данных о актуальном состоянии кластера
6. Новые ноды кластера слушают локальные порты ```9201``` и ```9202``` и доступны по адресу <http://localhost:9201>. 
Логика навешивания на порт ```9201``` задается строками в docker-compose.yaml:
    ```
    ports:
         - 9201:9200
    ```